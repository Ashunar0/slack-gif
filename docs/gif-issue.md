# GIFアニメーション破損: 原因と修正計画

## 事象
- アニメーション付きGIFのダウンロード結果が壊れる
- 静止PNGは正常
- すべてのアニメーションで再現

## 原因
`gifenc` の `quantize` / `applyPalette` は **RGBA（4バイト/ピクセル）** のフラット配列を前提にしているが、現状の実装は以下の2点が仕様と不一致。

1. **RGB配列（3バイト/ピクセル）を渡している**
   - `applyPalette` の入力がRGBA前提のため、バイト境界がずれてインデックスが破綻する。
2. **透明ピクセルを除外してパレット用の配列を作っている**
   - 画素順の連続性が崩れ、パレットとフレームの色対応が壊れる。

結果として、ストライプ状の乱れや色崩れが発生し、GIFが破損する。

## 修正方針
`gifenc` の仕様に合わせて **RGBA配列を維持したまま量子化・パレット適用** する。

## 修正計画
1. `encodeGIF` のパレット生成とフレーム処理を、RGBA配列ベースに統一する
   - `allPixels` を **全ピクセルのRGBA** で構築する（透明ピクセルも含める）
   - `applyPalette` に渡す入力もRGBA配列にする
2. 透明の扱いを設計に合わせて明示化する
   - 背景を白に固定したい場合: RGBAを事前に白合成してRGB相当の色にした上でRGBAとして渡す
   - 透明を残したい場合: `quantize` / `applyPalette` の `format` をRGBA系に合わせる
3. 既存フローとの整合性確認
   - `generateAnimationFrames` で生成する各フレームのサイズが同一であることを確認
   - 既存のPNGダウンロードフローは変更しない

## 影響範囲
- `utils/gif-encoder.ts` の `encodeGIF` のみ
- UIやアニメーション計算ロジックは変更不要

## 検証観点
- 全アニメーションプリセットで破損が解消される
- 色崩れやストライプ状の乱れが発生しない
- 出力GIFがSlack側で正常に再生される
